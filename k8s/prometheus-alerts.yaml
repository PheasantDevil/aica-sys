apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: default
data:
  alerts.yml: |
    groups:
      - name: aica-sys-alerts
        interval: 30s
        rules:
          # 高いエラー率
          - alert: HighErrorRate
            expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "高いエラー率を検出"
              description: "エラー率が5%を超えています (現在: {{ $value }})"

          # 遅いレスポンス
          - alert: SlowResponseTime
            expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "レスポンス時間が遅い"
              description: "P95レスポンス時間が1秒を超えています (現在: {{ $value }}s)"

          # CPU使用率が高い
          - alert: HighCPUUsage
            expr: rate(process_cpu_seconds_total[5m]) * 100 > 80
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "CPU使用率が高い"
              description: "CPU使用率が80%を超えています (現在: {{ $value }}%)"

          # メモリ使用率が高い
          - alert: HighMemoryUsage
            expr: (process_resident_memory_bytes / node_memory_MemTotal_bytes) * 100 > 80
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "メモリ使用率が高い"
              description: "メモリ使用率が80%を超えています (現在: {{ $value }}%)"

          # Pod がダウン
          - alert: PodDown
            expr: up{job="backend"} == 0
            for: 2m
            labels:
              severity: critical
            annotations:
              summary: "Pod がダウンしています"
              description: "{{ $labels.pod }} がダウンしています"

          # データベース接続エラー
          - alert: DatabaseConnectionError
            expr: rate(database_errors_total[5m]) > 0
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "データベース接続エラー"
              description: "データベース接続エラーが発生しています"

          # キャッシュヒット率が低い
          - alert: LowCacheHitRate
            expr: rate(cache_hits_total[5m]) / rate(cache_requests_total[5m]) < 0.5
            for: 10m
            labels:
              severity: warning
            annotations:
              summary: "キャッシュヒット率が低い"
              description: "キャッシュヒット率が50%未満です (現在: {{ $value }})"

          # ディスク使用率が高い
          - alert: HighDiskUsage
            expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 < 20
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "ディスク使用率が高い"
              description: "ディスク空き容量が20%未満です"

          # 大量のリクエスト
          - alert: HighRequestRate
            expr: rate(http_requests_total[5m]) > 1000
            for: 5m
            labels:
              severity: info
            annotations:
              summary: "リクエスト数が多い"
              description: "リクエスト数が1000/sを超えています (現在: {{ $value }}/s)"

          # レプリカ数が少ない
          - alert: LowReplicaCount
            expr: kube_deployment_status_replicas_available{deployment="aica-sys-backend"} < 2
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "レプリカ数が少ない"
              description: "利用可能なレプリカ数が2未満です"
