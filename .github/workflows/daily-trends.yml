name: Daily Trend Analysis

on:
  schedule:
    # ÊØéÊó•ÂçàÂâç10ÊôÇÔºàJST = UTC 1:00Ôºâ
    - cron: "0 1 * * *"
  workflow_dispatch: # ÊâãÂãïÂÆüË°å
  push:
    branches:
      - main
    paths:
      - "backend/services/trend_analysis_service.py"
      - "backend/models/automated_content.py"
      - "scripts/analyze_trends.py"
      - ".github/workflows/daily-trends.yml"

jobs:
  analyze-trends:
    name: Analyze Daily Trends
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Check Python version
        run: |
          python3 --version
          pip --version

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Verify dependencies installed
        run: |
          cd backend
          pip list | grep -E "(requests|sqlalchemy)" || exit 1

      - name: Check database connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ö†Ô∏è DATABASE_URL not set, skipping database connection check"
            exit 0
          fi
          python3 -c "from pathlib import Path; import sys; sys.path.insert(0, str(Path('backend'))); from database import SessionLocal; db = SessionLocal(); db.close(); print('‚úÖ Database connection OK')"

      - name: Check current migration status
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ö†Ô∏è DATABASE_URL not set, skipping migration check"
            exit 0
          fi
          cd backend
          echo "üìä Current migration status:"
          python3 -m alembic current || echo "‚ö†Ô∏è No migrations applied yet"
          echo ""
          echo "üìã Available migrations:"
          python3 -m alembic history --verbose | head -30
          echo ""
          echo "üîç Checking DATABASE_URL connection type:"
          if echo "$DATABASE_URL" | grep -q "pooler.supabase.com"; then
            if echo "$DATABASE_URL" | grep -q ":6543"; then
              echo "‚úÖ Using Session pooler (port 6543) - Good for migrations"
            elif echo "$DATABASE_URL" | grep -q ":5432"; then
              echo "‚ö†Ô∏è Using Transaction pooler (port 5432) - May cause migration issues"
              echo "üí° Consider switching to Session pooler for migrations"
            fi
          fi
          echo ""
          echo "üîç Checking alembic_version table:"
          python3 << 'EOF'
          from pathlib import Path
          import sys
          sys.path.insert(0, str(Path('.').resolve()))
          from sqlalchemy import text
          from database import engine

          with engine.connect() as conn:
              result = conn.execute(text("SELECT version_num FROM alembic_version"))
              versions = [row[0] for row in result]
              print(f"Applied migrations: {', '.join(versions)}")
          EOF

      - name: Run database migrations
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -e
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ö†Ô∏è DATABASE_URL not set, skipping migrations"
            exit 0
          fi
          cd backend
          echo "‚¨ÜÔ∏è Running migrations..."
          python3 -m alembic history || echo "‚ö†Ô∏è Could not get migration history"
          echo ""
          echo "üìä Current revision:"
          python3 -m alembic current || echo "‚ö†Ô∏è No current revision"
          echo ""
          echo "üîç Checking if migration 4741adeef488 needs to be applied..."
          python3 scripts/check_migration_4741.py || NEEDS_4741=1
          NEEDS_4741=${NEEDS_4741:-0}
          if [ $NEEDS_4741 -ne 0 ]; then
            echo "Fixing migration chain..."
            python3 scripts/fix_migration_chain.py
            echo "üöÄ Applying migrations..."
            python3 -m alembic upgrade head
          else
            echo "üöÄ Applying any pending migrations..."
            python3 -m alembic upgrade head
          fi
          echo "‚úÖ Migrations completed"
          python3 -m alembic current

      - name: Verify tables exist
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ö†Ô∏è DATABASE_URL not set, skipping table verification"
            exit 0
          fi
          cd backend
          python3 << 'EOF'
          from pathlib import Path
          import sys
          sys.path.insert(0, str(Path('.').resolve()))
          from sqlalchemy import inspect, text
          from database import engine

          print("üîç Checking database connection...")
          try:
              with engine.connect() as conn:
                  result = conn.execute(text("SELECT version();"))
                  version = result.fetchone()[0]
                  print(f"‚úÖ Connected to: {version[:50]}...")
          except Exception as e:
              print(f"‚ùå Database connection error: {e}")
              sys.exit(1)

          print("\nüìã Listing all tables in database...")
          inspector = inspect(engine)
          tables = inspector.get_table_names()
          print(f"Found {len(tables)} tables: {', '.join(sorted(tables))}")

          print("\nüîç Checking alembic_version table:")
          with engine.connect() as conn:
              try:
                  result = conn.execute(text("SELECT version_num FROM alembic_version"))
                  versions = [row[0] for row in result]
                  print(f"Applied migration versions: {', '.join(versions)}")
                  
                  # Check if 4741adeef488 is in the list
                  if '4741adeef488' not in versions:
                      print("\n‚ö†Ô∏è WARNING: Migration 4741adeef488 (create automated content tables) is NOT recorded!")
                      print("This means the migration was never applied, even though alembic current shows head.")
                      print("This is likely why the tables don't exist.")
              except Exception as e:
                  print(f"‚ö†Ô∏è Could not check alembic_version: {e}")

          required_tables = ['source_data', 'trend_data', 'automated_contents', 'content_generation_logs']
          missing = [t for t in required_tables if t not in tables]

          if missing:
              print(f"\n‚ùå Missing tables: {', '.join(missing)}")
              print("\nüí° Possible solutions:")
              print("   1. If 4741adeef488 is not in alembic_version:")
              print("      - Manually stamp the migration: alembic stamp 4741adeef488")
              print("      - Then run: alembic upgrade head")
              print("   2. If 4741adeef488 is in alembic_version but tables are missing:")
              print("      - Create tables manually in Supabase Dashboard SQL Editor")
              print("      - Or reset alembic_version and re-run migrations")
              print("   3. Check Supabase dashboard for table creation errors")
              sys.exit(1)
          else:
              print(f"\n‚úÖ All required tables exist: {', '.join(required_tables)}")
          EOF

      - name: Verify scripts exist
        run: |
          test -f scripts/analyze_trends.py || exit 1
          chmod +x scripts/analyze_trends.py || true
          echo "‚úÖ Script exists"

      - name: Ensure public directory exists
        run: |
          mkdir -p public
          echo "‚úÖ Public directory ready"

      - name: Run trend analysis
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ö†Ô∏è DATABASE_URL not set, skipping trend analysis"
            exit 0
          fi
          python3 scripts/analyze_trends.py

      - name: Commit trend data
        if: success()
        run: |
          if [ ! -f "public/trends-latest.json" ]; then
            echo "‚ö†Ô∏è trends-latest.json not found, skipping commit"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add public/trends-latest.json
          if git diff --quiet && git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No changes to commit"
            exit 0
          fi
          git commit -m "chore: Update daily trend data [skip ci]"
          git push

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå Daily Trend Analysis Failed',
              body: `Daily trend analysis failed on ${new Date().toISOString()}\n\nCheck the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`,
              labels: ['automation', 'bug']
            })
