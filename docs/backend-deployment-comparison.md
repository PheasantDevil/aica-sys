# バックエンドデプロイサービス比較検証結果

## 検証日

2024年10月12日

## 検証目的

AICA-SySバックエンド（FastAPI）の最適なデプロイ先を選定

## ユーザー要件

1. ✅ **保守管理コスパが良い**（コストは無料がベスト）
2. ✅ **サービス復旧時に直前の状態に戻しやすい**

## 比較対象サービス

- Google Cloud Run
- Railway
- Render

---

## 詳細比較結果

### 1. Google Cloud Run

#### スペック

- **無料枠**: 月2百万リクエスト、180,000 vCPU秒
- **オートスケーリング**: 0→N、自動
- **リビジョン管理**: 過去バージョンに即座ロールバック
- **信頼性**: エンタープライズ級

#### コスト分析

- **無料枠内**: 月50時間実行可能
- **超過時**: $0.00002400/vCPU秒
- **予想**: $0-5/月（小規模）

#### 評価

| 項目       | スコア | コメント               |
| ---------- | ------ | ---------------------- |
| コスト     | ◎      | 無料枠寛容             |
| 復旧性     | ◎      | リビジョン管理が優秀   |
| 保守性     | △      | gcloud CLI、設定が複雑 |
| 学習コスト | △      | GCP知識が必要          |

**総合**: ⭐⭐⭐☆☆（エンタープライズ向け）

---

### 2. Railway

#### スペック

- **無料枠**: $5クレジット/月（約500時間実行）
- **自動デプロイ**: git push → 自動ビルド
- **PostgreSQL**: 内蔵（無料）
- **スリープ**: なし（常時起動）

#### コスト分析

- **Trial**: $5クレジット/月
- **Developer**: $5/月（$5クレジット付き）
- **実質**: ほぼ無料に近い

#### 評価

| 項目       | スコア | コメント                |
| ---------- | ------ | ----------------------- |
| コスト     | ○      | $5/月（クレジット含む） |
| 復旧性     | ◎◎     | 1クリックロールバック   |
| 保守性     | ◎◎     | 超簡単、トラブル少ない  |
| 学習コスト | ◎      | 最も簡単                |

**総合**: ⭐⭐⭐⭐☆（バランス型、復旧性最高）

---

### 3. Render

#### スペック

- **無料枠**: Free tier（512MB、0.1 CPU）
- **自動デプロイ**: git push → 自動ビルド
- **スリープ**: 15分非アクティブで自動スリープ
- **起動時間**: 30-60秒（コールドスタート）

#### コスト分析

- **Free**: $0（完全無料）⭐⭐⭐
- **Starter**: $7/月（スリープなし）
- **予想**: $0/月（Free継続）

#### 評価

| 項目         | スコア | コメント                     |
| ------------ | ------ | ---------------------------- |
| コスト       | ◎◎     | 完全無料                     |
| 復旧性       | ◎      | デプロイ履歴からロールバック |
| 保守性       | ◎      | 簡単、GUIで完結              |
| 学習コスト   | ◎      | 簡単                         |
| スリープ影響 | △      | 15分でスリープ、起動30-60秒  |

**総合**: ⭐⭐⭐⭐☆（コスト最優先）

---

## スリープ影響分析

### Phase 10ワークフローの実行パターン

```
月曜: 08:00 newsletter, 09:00 article, 10:00 trend
火曜: 09:00 article, 10:00 trend
水曜: 09:00 article, 10:00 trend
木曜: 09:00 article, 10:00 trend
金曜: 09:00 article, 10:00 trend
土曜: 10:00 trend
日曜: 10:00 trend
```

**最長非アクティブ期間**: 日曜10:00 → 月曜08:00 = **22時間**

**スリープ発生タイミング**:

- 毎日: 10:15以降、翌日実行まで
- 週末: 土曜・日曜の10:15以降

**ユーザー影響**:

- 初回アクセス: 30-60秒の遅延（1日1回程度）
- 以降: 高速（15分以内の再アクセス）

**許容度**: ⭐⭐⭐☆☆（開発・初期フェーズでは許容可能）

---

## Vercel vs Render（フロントエンド）

### Vercel（Next.js）の独自機能

| 機能                   | Vercel          | Render     | 重要度    |
| ---------------------- | --------------- | ---------- | --------- |
| **Speed Insights**     | ✅ 専用         | ❌ なし    | ⭐⭐⭐ 高 |
| **Image Optimization** | ✅ 自動         | △ 手動     | ⭐⭐⭐ 高 |
| **Edge Functions**     | ✅ あり         | ❌ なし    | ⭐⭐ 中   |
| **ISR**                | ✅ 完全対応     | △ 制限あり | ⭐⭐ 中   |
| **Middleware**         | ✅ 完全対応     | △ 制限あり | ⭐ 低     |
| **自動最適化**         | ✅ 多数         | △ 限定     | ⭐⭐ 中   |
| **グローバルCDN**      | ✅ Edge Network | ○ CDN      | ⭐⭐ 中   |

**結論**: VercelはNext.jsの開発元、最適化が圧倒的 ⭐⭐⭐⭐⭐

---

## 最終推奨構成

### ✅ 採用: **Vercel（Frontend）+ Render（Backend）**

```
┌─────────────────────────────────────┐
│  Frontend (Next.js)                 │
│  ├─ Vercel Hobby ($0/月)           │
│  ├─ Speed Insights 有効            │
│  ├─ 自動最適化                      │
│  └─ https://aica-sys.vercel.app    │
└─────────────────────────────────────┘
              ↓ API Call
┌─────────────────────────────────────┐
│  Backend (FastAPI)                  │
│  ├─ Render Free ($0/月)            │
│  ├─ スリープあり（許容）            │
│  ├─ 自動デプロイ                    │
│  └─ https://aica-sys-backend.       │
│     onrender.com                    │
└─────────────────────────────────────┘
```

### コスト

- **月額**: $0（完全無料）✅
- **年額**: $0

### 要件適合度

| 要件   | 評価 | 理由                             |
| ------ | ---- | -------------------------------- |
| コスパ | ◎◎   | 完全無料                         |
| 復旧性 | ◎    | 両方とも履歴からロールバック可能 |

### 追加メリット

- ✅ Next.js最適化（Vercel）
- ✅ Speed Insights活用
- ✅ 段階的スケール可能

### 許容するデメリット

- ⚠️ 2つのダッシュボード管理
- ⚠️ バックエンドスリープ（月曜朝のみ影響）

---

## 代替案（将来的）

### トラフィック増加時のスケールパス

**段階1（現在）**: Vercel + Render Free

- コスト: $0/月
- 対象: 開発・初期ローンチ（月間10,000 PV以下）

**段階2（成長期）**: Vercel + Render Starter

- コスト: $7/月
- 対象: スリープ解除、月間50,000 PV

**段階3（拡大期）**: Vercel + Cloud Run

- コスト: $10-30/月
- 対象: 高トラフィック、月間100,000+ PV

**段階4（本格運用）**: Vercel Enterprise + Cloud Run

- コスト: カスタム
- 対象: エンタープライズ級

---

## スリープ対策（オプション）

### 対策1: ヘルスチェックCron（GitHub Actions）

```yaml
# .github/workflows/backend-keepalive.yml
name: Backend Keep Alive

on:
  schedule:
    - cron: "*/10 * * * *" # 10分ごと

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping backend
        run: curl https://aica-sys-backend.onrender.com/health
```

**効果**: スリープ防止
**コスト**: GitHub Actions無料枠内
**推奨度**: ⭐⭐☆☆☆（あまり推奨しない、リソース浪費）

### 対策2: そのまま運用（推奨）

- Phase 10ワークフローが平日毎日実行
- 月曜朝の初回遅延は許容
- ユーザー体験への影響は最小限

**推奨度**: ⭐⭐⭐⭐⭐

---

## 結論

**Vercel（Frontend）+ Render Free（Backend）で実装開始**

次のステップ:

1. Render.comでアカウント作成
2. GitHubリポジトリ接続
3. バックエンド設定（Root: `backend/`）
4. 環境変数設定
5. デプロイ
6. Vercel環境変数更新（API_URL）

実装を開始します！
