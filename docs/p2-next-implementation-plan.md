# P2 次期実装計画

**作成日**: 2025年11月26日  
**ステータス**: 実装準備完了  
**実装期間**: 2-3週間（10-15営業日）

---

## 📊 現在の実装状況

### ✅ 完了済み

1. **P2-1.2 コミッション計算** (3日) ✅
   - ✅ コミッション計算ロジック（固定率、階層型、ティア別）
   - ✅ コミッション履歴の記録（conversionsテーブル）
   - ✅ 支払いステータス管理（payoutsテーブル）
   - ✅ コミッション履歴の表示（get_commission_report API）
   - ✅ 自動支払い機能（settle_commissions）
   - ✅ CLIレポート生成スクリプト

2. **バックエンド基盤** ✅
   - ✅ アフィリエイト登録API
   - ✅ 紹介リンク生成・管理API
   - ✅ クリック追跡API
   - ✅ コンバージョン記録・承認API
   - ✅ 報酬ルール管理API
   - ✅ 支払い管理API
   - ✅ 統計・レポートAPI

---

## 🎯 次期実装タスク（優先順位順）

### 1. パートナーポータル（フロントエンド）⏱️ 5日

**優先度**: ★★★★★ 最優先 - バックエンドAPIは実装済み

**実装内容**:

#### 1.1 パートナー登録・認証画面 ⏱️ 1.5日

- [ ] パートナー登録ページ (`/affiliate/register`)
  - 登録フォーム（既存ユーザー向け）
  - 利用規約・プライバシーポリシーへの同意
  - 登録完了メッセージ
- [ ] 認証統合
  - 既存のNextAuth.jsを活用
  - ログイン済みユーザーの自動登録
  - 未ログインユーザーへのログイン誘導

**技術実装**:
- `frontend/src/app/affiliate/register/page.tsx`
- `frontend/src/components/affiliate/RegisterForm.tsx`
- API: `POST /api/affiliate/register` (既存)

#### 1.2 パートナーダッシュボード ⏱️ 2.5日

- [ ] ダッシュボードメインページ (`/affiliate/dashboard`)
  - 概要統計カード（総クリック数、コンバージョン数、総収益、未払い残高）
  - 最近のアクティビティ一覧
  - クイックアクション（リンク生成、レポート表示）
- [ ] 紹介リンク管理セクション
  - リンク生成フォーム（キャンペーン名、有効期限設定）
  - リンク一覧表示（アクティブ/非アクティブ切り替え）
  - リンクのコピー機能
  - リンクの編集・削除機能
- [ ] 統計・パフォーマンス表示
  - クリック数・コンバージョン数の時系列グラフ
  - コンバージョン率の表示
  - トップパフォーマンスリンクの表示

**技術実装**:
- `frontend/src/app/affiliate/dashboard/page.tsx`
- `frontend/src/components/affiliate/DashboardStats.tsx`
- `frontend/src/components/affiliate/ReferralLinkManager.tsx`
- `frontend/src/components/affiliate/PerformanceChart.tsx`
- API: `GET /api/affiliate/profile/{user_id}` (既存)
- API: `GET /api/affiliate/referral-links/{affiliate_id}` (既存)
- API: `POST /api/affiliate/referral-links` (既存)

#### 1.3 コミッション・支払い管理セクション ⏱️ 1日

- [ ] コミッション履歴表示
  - コミッション一覧（ステータス別フィルタ）
  - コミッション詳細（コンバージョン情報、計算ロジック）
  - 期間別集計表示
- [ ] 支払い情報管理
  - 支払い履歴一覧
  - 支払いリクエスト機能
  - 支払いステータス表示

**技術実装**:
- `frontend/src/components/affiliate/CommissionHistory.tsx`
- `frontend/src/components/affiliate/PayoutManagement.tsx`
- API: `GET /api/affiliate/conversions` (既存)
- API: `GET /api/affiliate/payouts/{affiliate_id}` (既存)
- API: `POST /api/affiliate/payouts` (既存)

**理由**:
- バックエンドAPIは既に実装済み
- ユーザーが実際にアフィリエイトプログラムを利用できるようにする
- 収益化の実現に直結

---

### 2. アフィリエイト管理画面（管理者用）⏱️ 3日

**優先度**: ★★★★☆ 高 - 運用管理に必要

**実装内容**:

#### 2.1 パートナー管理画面 ⏱️ 1.5日

- [ ] パートナー一覧ページ (`/admin/affiliates`)
  - パートナー一覧表示（検索・フィルタ機能）
  - パートナー詳細表示（統計、履歴）
  - パートナー承認・却下機能
  - ティア変更機能
- [ ] パートナー統計表示
  - パートナー別パフォーマンス比較
  - トップパートナーランキング
  - セグメント別分析

**技術実装**:
- `frontend/src/app/admin/affiliates/page.tsx`
- `frontend/src/components/admin/AffiliateList.tsx`
- `frontend/src/components/admin/AffiliateDetail.tsx`
- API: `GET /api/affiliate/top-affiliates` (既存)
- API: `PUT /api/affiliate/{affiliate_id}/tier` (既存)

#### 2.2 リンク管理画面 ⏱️ 1日

- [ ] 全リンク一覧表示 (`/admin/affiliate-links`)
  - 全パートナーのリンクを一覧表示
  - リンクの有効/無効切り替え
  - リンクの有効期限管理
  - リンク別パフォーマンス表示

**技術実装**:
- `frontend/src/app/admin/affiliate-links/page.tsx`
- `frontend/src/components/admin/LinkManagement.tsx`
- API: `GET /api/affiliate/admin/referral-links` (既存)
- API: `PUT /api/affiliate/referral-links/{link_id}` (既存)

#### 2.3 クリック統計・分析画面 ⏱️ 0.5日

- [ ] クリック統計ダッシュボード (`/admin/affiliate-analytics`)
  - 全体統計表示
  - パートナー別・リンク別統計
  - 時系列グラフ表示

**技術実装**:
- `frontend/src/app/admin/affiliate-analytics/page.tsx`
- `frontend/src/components/admin/AffiliateAnalytics.tsx`
- API: `GET /api/affiliate/admin/click-statistics` (既存)

**理由**:
- アフィリエイトプログラムの運用管理
- 不正検出・パフォーマンス分析
- パートナーサポート

---

### 3. 分析・レポート機能強化（Phase 9-5）⏱️ 16日

**優先度**: ★★★★☆ 高 - データドリブンな意思決定

**実装内容**:

#### 3.1 ユーザー行動分析の詳細化 ⏱️ 4日

- [ ] ページビュー詳細トラッキング
  - ページ滞在時間の記録
  - スクロール深度の測定
  - 離脱ポイントの分析
- [ ] セッション時間分析
  - セッション開始・終了の記録
  - セッション内の行動フロー
  - セッション品質スコア
- [ ] コンバージョンファネル分析
  - ファネルステージの定義
  - 各ステージのコンバージョン率
  - ドロップオフポイントの特定
- [ ] ユーザーセグメント分析
  - セグメント定義（新規/既存、有料/無料等）
  - セグメント別の行動パターン
  - セグメント別のコンバージョン率

**技術実装**:
- `backend/models/analytics.py` の拡張
- `backend/services/analytics_service.py` に分析メソッド追加
- フロントエンド: 分析ダッシュボードの拡張

#### 3.2 コンテンツパフォーマンス分析 ⏱️ 3日

- [ ] 記事別パフォーマンスダッシュボード
  - PV数、UU数、平均滞在時間
  - エンゲージメント率（いいね、シェア、コメント）
  - コンバージョン率（有料会員への転換）
- [ ] エンゲージメント率計算
  - いいね数、シェア数、コメント数の集計
  - エンゲージメント率の算出
  - トレンド分析
- [ ] シェア数トラッキング
  - SNSシェアボタンのクリック追跡
  - シェア先プラットフォームの記録
- [ ] コメント数・いいね数分析
  - コメント・いいねの時系列分析
  - トップパフォーマンス記事の特定

**技術実装**:
- `backend/routers/analytics_router.py` にエンドポイント追加
- フロントエンド: 記事別パフォーマンスページ

#### 3.3 収益レポート ⏱️ 4日

- [ ] MRR（月次経常収益）レポート
  - 月次MRRの計算・表示
  - MRR推移グラフ
  - プラン別MRR内訳
- [ ] ARR（年次経常収益）レポート
  - 年次ARRの計算・表示
  - ARR成長率の分析
- [ ] LTV（顧客生涯価値）計算
  - 顧客別LTVの算出
  - セグメント別平均LTV
- [ ] CAC（顧客獲得コスト）計算
  - チャネル別CACの算出
  - LTV/CAC比率分析

**技術実装**:
- `backend/services/analytics_service.py` に計算ロジック追加
- フロントエンド: 収益レポートダッシュボード

#### 3.4 ビジネスインサイトダッシュボード ⏱️ 5日

- [ ] 収益推移グラフ
- [ ] ユーザー成長グラフ
- [ ] コンテンツ生成統計
- [ ] トップパフォーマンス記事
- [ ] 予測分析（機械学習ベース）

**技術実装**:
- フロントエンド: 統合ダッシュボード
- バックエンド: 集計API

**理由**:
- データドリブンな意思決定
- ビジネス成長の可視化
- KPI追跡

---

## 📅 実装スケジュール

### Week 1: パートナーポータル実装（5日）

| 日 | タスク | 所要時間 | 優先度 |
| --- | --- | --- | --- |
| Day 1 | パートナー登録・認証画面 | 6時間 | ★★★★★ |
| Day 2-3 | パートナーダッシュボード | 16時間 | ★★★★★ |
| Day 4 | コミッション・支払い管理 | 8時間 | ★★★★★ |
| Day 5 | テスト・バグ修正 | 8時間 | ★★★★★ |

### Week 2: 管理画面実装（3日）

| 日 | タスク | 所要時間 | 優先度 |
| --- | --- | --- | --- |
| Day 6-7 | パートナー管理画面 | 12時間 | ★★★★☆ |
| Day 8 | リンク管理・統計画面 | 8時間 | ★★★★☆ |

### Week 3-4: 分析・レポート機能（16日）

| 日 | タスク | 所要時間 | 優先度 |
| --- | --- | --- | --- |
| Day 9-12 | ユーザー行動分析の詳細化 | 32時間 | ★★★★☆ |
| Day 13-15 | コンテンツパフォーマンス分析 | 24時間 | ★★★★☆ |
| Day 16-19 | 収益レポート | 32時間 | ★★★★☆ |
| Day 20-24 | ビジネスインサイトダッシュボード | 40時間 | ★★★★☆ |

**合計**: 約24営業日（約5週間）

---

## 🎯 実装の優先順位（推奨）

### フェーズ 1: 収益化完了（Week 1-2）

1. **パートナーポータル** (5日) - 最優先
   - ユーザーがアフィリエイトプログラムを利用可能に
   - 収益化の実現

2. **管理画面** (3日) - 高優先度
   - 運用管理の効率化
   - パートナーサポート

### フェーズ 2: データ分析強化（Week 3-4）

3. **分析・レポート機能強化** (16日)
   - データドリブンな意思決定
   - ビジネス成長の可視化

---

## 📝 実装時の注意事項

1. **既存APIの活用**
   - バックエンドAPIは既に実装済み
   - API仕様を確認してから実装開始

2. **認証・認可**
   - 既存のNextAuth.jsを活用
   - 管理者権限のチェックを忘れずに

3. **レスポンシブデザイン**
   - モバイル対応を考慮
   - Tailwind CSSを活用

4. **エラーハンドリング**
   - API呼び出し時のエラーハンドリング
   - ユーザーフレンドリーなエラーメッセージ

5. **テスト**
   - 各機能のユニットテスト
   - E2Eテストの追加

---

## 🔄 次のステップ

1. **Week 1開始**: パートナーポータル実装
   - `feature/p2-partner-portal` ブランチを作成
   - パートナー登録画面から実装開始

2. **進捗管理**
   - 日次で進捗を確認
   - ブロッカーがあれば早期に報告

3. **コードレビュー**
   - 各機能実装後にPRを作成
   - CodeRabbitレビューを活用

